# 1.3 评价指标体系

## 引言

如何判断一个降噪算法的好坏？这需要一套科学的评价指标体系。

评价指标分为两大类：
1. **客观指标**：通过数学公式计算，可复现
2. **主观指标**：通过人工听音评估，更接近真实体验

作为算法设计者，你需要理解每个指标**测量的是什么**、**局限性是什么**，才能正确解读实验结果。

---

## 1.3.1 信噪比类指标

### 信噪比 (SNR)

最基础的指标，定义为信号功率与噪声功率的比值：

$$\text{SNR} = 10 \log_{10} \frac{P_s}{P_n} = 10 \log_{10} \frac{\sum_n s^2(n)}{\sum_n n^2(n)} \text{ (dB)}$$

**输入SNR vs 输出SNR**：
- 输入SNR：带噪信号的信噪比
- 输出SNR：降噪后信号的信噪比
- SNR改善：$\Delta\text{SNR} = \text{SNR}_{out} - \text{SNR}_{in}$

**局限性**：
- 需要知道纯净信号（参考信号）
- 不考虑语音失真
- 与主观感知相关性有限

### 分段信噪比 (Segmental SNR, SegSNR)

对每帧计算SNR后取平均，更能反映时变特性：

$$\text{SegSNR} = \frac{1}{M} \sum_{m=0}^{M-1} 10 \log_{10} \frac{\sum_{n=0}^{N-1} s^2(mH+n)}{\sum_{n=0}^{N-1} [s(mH+n) - \hat{s}(mH+n)]^2}$$

通常会对每帧SNR做截断（如限制在[-10, 35]dB），避免静音帧的影响。

### 尺度不变信噪比 (SI-SNR / SI-SDR)

**现代深度学习方法最常用的指标**，解决了传统SNR对尺度敏感的问题：

$$\text{SI-SNR} = 10 \log_{10} \frac{\|s_{target}\|^2}{\|e_{noise}\|^2}$$

其中：
$$s_{target} = \frac{\langle \hat{s}, s \rangle}{\|s\|^2} s$$
$$e_{noise} = \hat{s} - s_{target}$$

**关键特性**：
- 对估计信号的整体缩放不敏感
- 只关注信号的"形状"是否正确
- 是很多端到端模型的训练目标

**SI-SNR改善 (SI-SNRi)**：
$$\text{SI-SNRi} = \text{SI-SNR}(\hat{s}, s) - \text{SI-SNR}(y, s)$$

---

## 1.3.2 感知质量指标

### PESQ (Perceptual Evaluation of Speech Quality)

ITU-T P.862标准，模拟人耳的感知过程：

```
处理流程：
1. 时间对齐（参考信号与测试信号）
2. 听觉变换（模拟耳蜗滤波）
3. 时频分析
4. 认知建模（计算感知差异）
5. 输出MOS分数
```

**分数范围**：-0.5 到 4.5（通常映射到1-5的MOS分数）

| 分数 | 质量等级 |
|------|----------|
| 4.0+ | 优秀 |
| 3.5-4.0 | 良好 |
| 3.0-3.5 | 一般 |
| 2.5-3.0 | 较差 |
| <2.5 | 差 |

**局限性**：
- 设计用于窄带语音（8kHz），宽带版本(PESQ-WB)效果有限
- 对某些失真类型不敏感
- 计算较慢

### POLQA (Perceptual Objective Listening Quality Analysis)

ITU-T P.863标准，PESQ的继任者：

- 支持超宽带语音（最高14kHz）
- 更好的时间对齐算法
- 对现代编解码器更准确

**分数范围**：1.0 到 4.75

### DNSMOS (Deep Noise Suppression MOS)

微软提出的基于深度学习的MOS预测器：

```
特点：
- 不需要参考信号（非侵入式）
- 基于大规模人工标注训练
- 输出多个维度的分数
```

**DNSMOS P.835 输出**：
- **SIG**：语音质量 (1-5)
- **BAK**：背景噪声质量 (1-5)
- **OVRL**：整体质量 (1-5)

**GTCRN论文中使用的指标**：DNSMOS P.808，直接预测整体MOS分数。

#### DNSMOS详细技术说明

**开发背景**：
DNSMOS由微软研究院开发，专门针对噪声抑制场景设计。传统的客观指标（如PESQ、POLQA）在语音增强任务中与人类主观评分的相关性较差，且需要参考纯净语音信号，在实际应用中往往不可获得。

**技术架构**：
- 采用多阶段自学习的深度神经网络方法
- 直接对降级信号进行质量评分，无需参考信号
- 基于大规模人工标注数据训练，使用实际人类意见评分作为标签

**训练数据规模**：
- 在419,000个去噪样本上训练
- 使用了320种不同的DNS模型生成的样本
- 覆盖多种噪声类型、SNR条件和说话人

**版本演进**：
- **DNSMOS P.808**：预测整体MOS分数（1-5分）
- **DNSMOS P.835**：提供三个维度的独立评分（SIG、BAK、OVRL）
- **DNSMOS v2/v3**：持续改进，增加更多训练数据和优化模型架构

#### DNSMOS可信度分析

**高可信度的优势**：

1. **与人类评分高度相关**：
   - 在具有挑战性的测试条件下表现出良好的泛化能力
   - 相关系数通常在0.85-0.92之间，显著优于传统客观指标
   - 特别适用于噪声抑制场景，针对性强

2. **数据驱动的可靠性**：
   - 基于真实的人类主观评分训练，而非其他客观指标的代理
   - 大规模多样化的训练数据确保了模型的鲁棒性
   - 持续通过新的主观实验数据进行验证和改进

3. **实际应用验证**：
   - 被广泛应用于Microsoft Teams、Skype等实际产品中
   - 成为DNS Challenge等国际竞赛的标准评估指标
   - 在学术界和工业界都获得了广泛认可

**局限性和注意事项**：

1. **领域依赖性**：
   - 主要针对英语语音和常见噪声类型训练
   - 对于其他语言或特殊噪声环境可能需要重新校准
   - 在极端失真条件下可能不如人工评分准确

2. **黑盒性质**：
   - 作为深度学习模型，内部决策过程不够透明
   - 难以解释具体的评分原因
   - 可能存在未知的偏见或盲点

3. **版本差异**：
   - 不同版本的DNSMOS可能给出不同的绝对分数
   - 在比较不同研究时需要注意使用相同版本
   - 建议同时报告多个指标以获得全面评估

**与其他指标的对比**：

| 指标 | 是否需要参考 | 相关性 | 计算复杂度 | 适用场景 |
|------|-------------|--------|------------|----------|
| PESQ | 是 | 中等(0.7-0.8) | 高 | 传统通信系统 |
| POLQA | 是 | 较高(0.75-0.85) | 很高 | 高质量通信 |
| DNSMOS | 否 | 高(0.85-0.92) | 中等 | 噪声抑制、实时系统 |
| SI-SNR | 是 | 低-中等 | 低 | 算法开发、训练目标 |

**实践建议**：
- 在噪声抑制研究中，DNSMOS应作为主要的感知质量指标
- 结合SI-SNR等信噪比指标，获得全面的性能评估
- 注意报告使用的DNSMOS具体版本（P.808或P.835）
- 对于关键应用，仍建议进行小规模的人工主观测试验证

---

## 1.3.3 可懂度指标

### STOI (Short-Time Objective Intelligibility)

测量语音的可懂度，与人类听懂语音的能力相关：

$$\text{STOI} = \frac{1}{M} \sum_m d_m$$

其中 $d_m$ 是第 $m$ 帧的相关系数，计算过程：
1. 将信号分解到1/3倍频程频带
2. 计算每个频带的短时能量包络
3. 计算参考信号与测试信号包络的相关性

**分数范围**：0 到 1
- 0.9+：高可懂度
- 0.7-0.9：中等可懂度
- <0.7：低可懂度

### ESTOI (Extended STOI)

STOI的改进版本，对调制频率更敏感：

- 更好地预测低SNR下的可懂度
- 对非线性处理更鲁棒

---

## 1.3.4 工程指标

对于实际部署，工程指标同样重要：

### 参数量 (Parameters)

模型的参数总数，决定：
- 模型文件大小
- 内存占用
- 是否能部署到边缘设备

```
GTCRN: 48.2K 参数
对比：
- RNNoise: ~100K
- DCCRN: ~3.7M
- FullSubNet: ~5.6M
```

### 计算量 (MACs/FLOPs)

每秒需要的乘加运算次数：

```
MACs = Multiply-Accumulate Operations
FLOPs ≈ 2 × MACs

GTCRN: 33.0 MMACs/s (每秒3300万次乘加)
```

**计算量的意义**：
- 决定能否实时运行
- 影响功耗和发热
- 影响能否在特定硬件上部署

### 实时因子 (RTF, Real-Time Factor)

$$\text{RTF} = \frac{\text{处理时间}}{\text{音频时长}}$$

- RTF < 1：可以实时处理
- RTF = 0.5：处理速度是实时的2倍
- RTF = 0.07：GTCRN在CPU上的表现

### 延迟 (Latency)

算法引入的延迟，对实时通信至关重要：

```
延迟来源：
1. 帧长：需要收集一帧数据才能处理
2. 帧移：输出的更新间隔
3. 前瞻：某些算法需要未来帧信息
4. 计算时间：处理一帧的时间

总延迟 ≈ 帧长 + 前瞻 + 计算时间
```

**实时通信要求**：
- 单向延迟 < 150ms（可接受）
- 单向延迟 < 40ms（高质量）

### 内存占用

运行时的内存需求：
- 模型参数
- 中间激活值
- 输入输出缓冲区

---

## 1.3.5 指标之间的权衡

### 质量 vs 可懂度

有时候这两个目标会冲突：

```
场景：强噪声环境

激进降噪：
- 噪声去除干净 → 高BAK分数
- 语音也被损伤 → 低SIG分数、低STOI

保守降噪：
- 语音保留完整 → 高SIG分数、高STOI
- 残留噪声多 → 低BAK分数
```

### 性能 vs 效率

经典的工程权衡：

```
更大的模型 → 更好的性能 → 更高的计算量
更小的模型 → 更低的计算量 → 性能可能下降

GTCRN的贡献：在极低计算量下达到competitive性能
```

### 如何选择指标？

根据应用场景选择关注的指标：

| 应用场景 | 主要指标 | 次要指标 |
|----------|----------|----------|
| 语音通信 | PESQ, 延迟 | STOI, RTF |
| 语音识别前端 | STOI, WER | SI-SNR |
| 助听器 | STOI, 功耗 | PESQ |
| 录音后处理 | PESQ, SI-SNR | 无实时要求 |

---

## 1.3.6 GTCRN的评估结果解读

论文中GTCRN的性能（供参考）：

**VCTK-DEMAND数据集**：
| 指标 | GTCRN | RNNoise |
|------|-------|---------|
| SI-SNR | 18.83 | 15.45 |
| PESQ | 2.87 | 2.54 |
| 参数量 | 48.2K | ~100K |

**DNS Challenge数据集**：
| 指标 | GTCRN |
|------|-------|
| DNSMOS P.808 | 3.44 |
| RTF (CPU) | 0.07 |

**解读**：
- SI-SNR 18.83dB：信号质量很好
- PESQ 2.87：感知质量中等偏上
- DNSMOS 3.44：整体主观质量良好（根据DNSMOS标准，>3.0即为可接受）
- 参数量仅48.2K：极致轻量化
- RTF 0.07：远超实时，有很大余量

---

## 本节小结

| 指标类别 | 代表指标 | 测量内容 |
|----------|----------|----------|
| 信噪比类 | SI-SNR | 信号失真程度 |
| 感知质量 | PESQ, DNSMOS | 主观听感 |
| 可懂度 | STOI | 语音清晰度 |
| 工程指标 | 参数量, MACs, RTF | 部署可行性 |

---

## 思考题

1. 为什么SI-SNR比传统SNR更适合作为深度学习的训练目标？

2. PESQ分数高是否一定意味着语音可懂度高？举例说明。

3. 一个模型的RTF=0.5意味着什么？它能用于实时通信吗？

4. 如果你要设计一个助听器的降噪算法，你会优先优化哪些指标？为什么？

5. GTCRN的参数量只有48.2K，但性能超过了100K参数的RNNoise，这说明了什么？

6. **新增**：DNSMOS相比传统客观指标有什么优势？在什么情况下你仍然需要进行人工主观测试？

---

## 实践建议

### 评估工具

```python
# PESQ
from pesq import pesq
score = pesq(16000, ref, deg, 'wb')

# STOI
from pystoi import stoi
score = stoi(ref, deg, 16000)

# SI-SNR
def si_snr(ref, est):
    ref = ref - ref.mean()
    est = est - est.mean()
    dot = (est * ref).sum()
    s_target = dot * ref / (ref ** 2).sum()
    e_noise = est - s_target
    return 10 * np.log10((s_target ** 2).sum() / (e_noise ** 2).sum())

# DNSMOS (需要安装dnsmos包)
from dnsmos import get_dnsmos
sig_score, bak_score, ovrl_score = get_dnsmos(audio_file, mode='p835')
```

### 评估注意事项

1. **对齐**：确保参考信号和测试信号时间对齐
2. **采样率**：确保采样率匹配（PESQ要求16kHz或8kHz）
3. **归一化**：某些指标对音量敏感，需要归一化
4. **多样性**：在多种噪声类型和SNR下测试
5. **DNSMOS使用**：注意版本选择，P.835提供更详细的维度分析

---

## 延伸阅读

- ITU-T P.862: PESQ标准文档
- ITU-T P.863: POLQA标准文档
- Taal, C. H., et al. (2011). "An Algorithm for Intelligibility Prediction of Time-Frequency Weighted Noisy Speech" (STOI)
- Le Roux, J., et al. (2019). "SDR – Half-baked or Well Done?" (SI-SDR分析)
- Reddy, C. K. A., et al. (2021). "DNSMOS: A Non-Intrusive Perceptual Objective Speech Quality Metric to Evaluate Noise Suppressors"
- Microsoft DNS Challenge 官方文档和评估协议